/*! Built with http://stenciljs.com */
const{h:e}=window.ionicpwaelements;let t=window.ImageCapture;void 0===t&&(t=class{constructor(e){if("video"!==e.kind)throw new DOMException("NotSupportedError");this._videoStreamTrack=e,"readyState"in this._videoStreamTrack||(this._videoStreamTrack.readyState="live"),this._previewStream=new MediaStream([e]),this.videoElement=document.createElement("video"),this.videoElementPlaying=new Promise(e=>{this.videoElement.addEventListener("playing",e)}),HTMLMediaElement?this.videoElement.srcObject=this._previewStream:this.videoElement.src=URL.createObjectURL(this._previewStream),this.videoElement.muted=!0,this.videoElement.setAttribute("playsinline",""),this.videoElement.play(),this.canvasElement=document.createElement("canvas"),this.canvas2dContext=this.canvasElement.getContext("2d")}get videoStreamTrack(){return this._videoStreamTrack}getPhotoCapabilities(){return new Promise(function(e,t){const i={current:0,min:0,max:0};e({exposureCompensation:i,exposureMode:"none",fillLightMode:["none"],focusMode:"none",imageHeight:i,imageWidth:i,iso:i,redEyeReduction:!1,whiteBalanceMode:"none",zoom:i}),t(new DOMException("OperationError"))})}setOptions(e={}){return new Promise(function(e,t){})}takePhoto(){const e=this;return new Promise(function(t,i){if("live"!==e._videoStreamTrack.readyState)return i(new DOMException("InvalidStateError"));e.videoElementPlaying.then(()=>{try{e.canvasElement.width=e.videoElement.videoWidth,e.canvasElement.height=e.videoElement.videoHeight,e.canvas2dContext.drawImage(e.videoElement,0,0),e.canvasElement.toBlob(t)}catch(e){i(new DOMException("UnknownError"))}})})}grabFrame(){const e=this;return new Promise(function(t,i){if("live"!==e._videoStreamTrack.readyState)return i(new DOMException("InvalidStateError"));e.videoElementPlaying.then(()=>{try{e.canvasElement.width=e.videoElement.videoWidth,e.canvasElement.height=e.videoElement.videoHeight,e.canvas2dContext.drawImage(e.videoElement,0,0),t(window.createImageBitmap(e.canvasElement))}catch(e){i(new DOMException("UnknownError"))}})})}}),window.ImageCapture=t;class i{constructor(){this.facingMode="user",this.showShutterOverlay=!1,this.flashIndex=0,this.cameraError=!1,this.hasMultipleCameras=!1,this.hasFlash=!1,this.flashModes=[],this.flashMode="off"}async componentDidLoad(){this.isServer||(this.defaultConstraints={video:{facingMode:this.facingMode}},await this.queryDevices(),await this.initCamera())}componentDidUnload(){this.stopStream(),this.photoSrc&&URL.revokeObjectURL(this.photoSrc)}hasImageCapture(){return"ImageCapture"in window}async queryDevices(){const e=await navigator.mediaDevices.enumerateDevices();this.hasMultipleCameras=e.filter(e=>"videoinput"==e.kind).length>1}async initCamera(e){e||(e=this.defaultConstraints);try{const t=await navigator.mediaDevices.getUserMedia(Object.assign({video:!0,audio:!1},e));this.initStream(t)}catch(e){this.cameraError=!0,this.cameraErrorString=this.buildError(e),console.error(e)}}buildError(e){switch(e.name){case"DevicesNotFoundError":return"No Camera found"}return"Unable to initialize Camera"}async initStream(e){this.stream=e,this.videoElement.srcObject=e,console.log(e.getVideoTracks()[0]),this.hasImageCapture()&&(this.imageCapture=new window.ImageCapture(e.getVideoTracks()[0]),await this.initPhotoCapabilities(this.imageCapture)),this.el.forceUpdate()}async initPhotoCapabilities(e){const t=await e.getPhotoCapabilities();t.fillLightMode.length>1&&(this.flashModes=t.fillLightMode.map(e=>e),this.flashMode?(this.flashMode=this.flashModes[this.flashModes.indexOf(this.flashMode)]||"off",this.flashIndex=this.flashModes.indexOf(this.flashMode)||0):this.flashIndex=0)}stopStream(){this.stream&&this.stream.getTracks().forEach(e=>e.stop())}async capture(){if(this.hasImageCapture())try{const e=await this.imageCapture.takePhoto({fillLightMode:this.flashModes.length>1?this.flashMode:void 0});await this.flashScreen(),this.promptAccept(e)}catch(e){console.error("Unable to take photo!",e)}}async promptAccept(e){this.photo=e,this.photoSrc=URL.createObjectURL(e)}rotate(){this.stopStream();const e=this.stream&&this.stream.getTracks()[0];if(!e)return;let t=e.getConstraints().facingMode;t||(t=e.getCapabilities().facingMode[0]),this.initCamera("environment"===t?{video:{facingMode:"user"}}:{video:{facingMode:"environment"}})}setFlashMode(e){console.log("New flash mode: ",e),this.flashMode=e}cycleFlash(){this.flashModes.length>0&&(this.flashIndex=(this.flashIndex+1)%this.flashModes.length,this.setFlashMode(this.flashModes[this.flashIndex]))}async flashScreen(){return new Promise((e,t)=>{this.showShutterOverlay=!0,setTimeout(()=>{this.showShutterOverlay=!1,e()},100)})}handleShutterClick(e){console.log(),this.capture()}handleRotateClick(e){this.rotate()}handleClose(e){this.onPhoto.emit(null)}handleFlashClick(e){this.cycleFlash()}handleCancelPhoto(e){this.photo=null}handleAcceptPhoto(e){this.onPhoto.emit(this.photo)}render(){return e("div",{class:"camera-wrapper"},e("div",{class:"camera-header"},e("section",{class:"items"},e("div",{class:"item close",onClick:e=>this.handleClose(e)},e("img",{src:`${this.publicPath}icons/exit.svg`})),e("div",{class:"item flash",onClick:e=>this.handleFlashClick(e)},this.flashModes.length>0&&e("div",null,"off"==this.flashMode?e("img",{src:`${this.publicPath}icons/flash-off.svg`}):"","auto"==this.flashMode?e("img",{src:`${this.publicPath}icons/flash-auto.svg`}):"","flash"==this.flashMode?e("img",{src:`${this.publicPath}icons/flash-on.svg`}):"")))),this.photo&&e("div",{class:"accept"},e("div",{class:"accept-image",style:{backgroundImage:`url(${this.photoSrc})`}})),e("div",{class:"camera-video",style:{display:this.photo?"none":""}},this.cameraError&&e("div",{class:"error"},this.cameraErrorString),this.showShutterOverlay&&e("div",{class:"shutter-overlay"}),this.hasImageCapture()?e("video",{ref:e=>this.videoElement=e,autoplay:!0,playsinline:!0}):e("canvas",{ref:e=>this.canvasElement=e,width:"100%",height:"100%"})),e("div",{class:"camera-footer"},this.photo?e("section",{class:"items"},e("div",{class:"item accept-cancel",onClick:e=>this.handleCancelPhoto(e)},e("img",{src:`${this.publicPath}icons/retake.svg`})),e("div",{class:"item accept-use",onClick:e=>this.handleAcceptPhoto(e)},e("img",{src:`${this.publicPath}icons/confirm.svg`}))):[e("div",{class:"shutter",onClick:e=>this.handleShutterClick(e)},e("div",{class:"shutter-button"})),e("div",{class:"rotate",onClick:e=>this.handleRotateClick(e)},e("img",{src:`${this.publicPath}icons/reverse-camera.svg`})),{}]))}static get is(){return"ion-pwa-camera"}static get encapsulation(){return"shadow"}static get properties(){return{cameraError:{state:!0},cameraErrorString:{state:!0},el:{elementRef:!0},facingMode:{type:String,attr:"facing-mode"},flashIndex:{state:!0},isServer:{context:"isServer"},photo:{state:!0},photoSrc:{state:!0},publicPath:{context:"publicPath"},showShutterOverlay:{state:!0}}}static get events(){return[{name:"onPhoto",method:"onPhoto",bubbles:!0,cancelable:!0,composed:!0}]}static get style(){return".sc-ion-pwa-camera-h{--header-height:4em;--footer-height:9em;--shutter-size:6em;--icon-size-header:1.5em;--icon-size-footer:2.5em;--margin-size-header:1.5em;--margin-size-footer:2.0em;font-family:-apple-system,BlinkMacSystemFont,“Segoe UI”,“Roboto”,“Droid Sans”,“Helvetica Neue”,sans-serif;display:block}.items.sc-ion-pwa-camera, .sc-ion-pwa-camera-h{width:100%;height:100%}.items.sc-ion-pwa-camera{-webkit-box-sizing:border-box;box-sizing:border-box;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center}.items.sc-ion-pwa-camera   .item.sc-ion-pwa-camera{-ms-flex:1;flex:1;text-align:center}.items.sc-ion-pwa-camera   .item.sc-ion-pwa-camera:first-child{text-align:left}.items.sc-ion-pwa-camera   .item.sc-ion-pwa-camera:last-child{text-align:right}.camera-wrapper.sc-ion-pwa-camera{position:relative;display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;width:100%;height:100%}.camera-header.sc-ion-pwa-camera{color:#fff;background-color:#000;height:var(--header-height)}.camera-header.sc-ion-pwa-camera   .items.sc-ion-pwa-camera{padding:var(--margin-size-header)}.camera-footer.sc-ion-pwa-camera{position:relative;color:#fff;background-color:#000;height:var(--footer-height)}.camera-footer.sc-ion-pwa-camera   .items.sc-ion-pwa-camera{padding:var(--margin-size-footer)}.camera-video.sc-ion-pwa-camera{position:relative;-ms-flex:1;flex:1;overflow:hidden}.camera-video.sc-ion-pwa-camera, video.sc-ion-pwa-camera{background-color:#000}video.sc-ion-pwa-camera{width:100%;height:100%;max-height:100%;min-height:100%;z-index:-1;-o-object-fit:cover;object-fit:cover}.shutter.sc-ion-pwa-camera{position:absolute;left:50%;top:50%;width:var(--shutter-size);height:var(--shutter-size);margin-top:calc(var(--shutter-size) / -2);margin-left:calc(var(--shutter-size) / -2);border-radius:100%;background-color:#c6cdd8;padding:12px;-webkit-box-sizing:border-box;box-sizing:border-box}.shutter.sc-ion-pwa-camera:active   .shutter-button.sc-ion-pwa-camera{background-color:#9da9bb}.shutter-button.sc-ion-pwa-camera{background-color:#fff;border-radius:100%;width:100%;height:100%}.rotate.sc-ion-pwa-camera{display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;position:absolute;right:var(--margin-size-footer);top:0;height:100%;color:#fff}.rotate.sc-ion-pwa-camera, .rotate.sc-ion-pwa-camera   img.sc-ion-pwa-camera{width:var(--icon-size-footer)}.rotate.sc-ion-pwa-camera   img.sc-ion-pwa-camera{height:var(--icon-size-footer)}.shutter-overlay.sc-ion-pwa-camera{z-index:5;position:absolute;width:100%;height:100%;background-color:#000}.error.sc-ion-pwa-camera{width:100%;height:100%;color:#fff;display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center}.accept.sc-ion-pwa-camera{background-color:#000;-ms-flex:1;flex:1}.accept.sc-ion-pwa-camera   .accept-image.sc-ion-pwa-camera{width:100%;height:100%;background-position:50%;background-size:cover;background-repeat:no-repeat}.close.sc-ion-pwa-camera   img.sc-ion-pwa-camera, .flash.sc-ion-pwa-camera   img.sc-ion-pwa-camera{width:var(--icon-size-header);height:var(--icon-size-header)}.accept-cancel.sc-ion-pwa-camera   img.sc-ion-pwa-camera, .accept-use.sc-ion-pwa-camera   img.sc-ion-pwa-camera{width:var(--icon-size-footer);height:var(--icon-size-footer)}"}}class a{async present(){var e=document.querySelector("ion-modal-controller");e||(e=document.createElement("ion-modal-controller"),document.body.appendChild(e)),await e.componentOnReady();const t=document.createElement("ion-pwa-camera");t.addEventListener("onPhoto",async e=>{this.onPhoto.emit(e.detail)});const i=await e.create({component:t});this._modal=i,i.present()}async dismiss(){this._modal&&this._modal.dismiss()}render(){return e("div",null)}static get is(){return"ion-pwa-camera-modal"}static get encapsulation(){return"shadow"}static get properties(){return{dismiss:{method:!0},present:{method:!0}}}static get events(){return[{name:"onPhoto",method:"onPhoto",bubbles:!0,cancelable:!0,composed:!0}]}}export{i as IonPwaCamera,a as IonPwaCameraModal};